<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>milk: Function Parameter Structure (FPS)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">milk
   &#160;<span id="projectnumber">1.01</span>
   </div>
   <div id="projectbrief">Modular Image processing Library toolKit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_FunctionParameterStructure.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Function Parameter Structure (FPS) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#page_FunctionParameterStructure_Overview">1. Overview and background</a></li>
<li class="level1"><a href="#page_FunctionParameterStructure_UserInterface">2. FPS user interface</a><ul><li class="level2"><a href="#page_FunctionParameterStructure_WritingFPSCMDscripts">2.1. Building command scripts from a `fpslist.txt` file</a></li>
<li class="level2"><a href="#page_FunctionParameterStructure_fpsCTRL">2.2. fpsCTRL tool</a></li>
</ul>
</li>
<li class="level1"><a href="#page_FunctionParameterStructure_WritingCLIfunc">3. Writing the CLI function (in &lt;module&gt;.c file)</a></li>
<li class="level1"><a href="#page_FunctionParameterStructure_WritingPrototypes">4. Writing function prototypes (in &lt;module&gt;.h)</a></li>
<li class="level1"><a href="#page_FunctionParameterStructure_WritingCONFfunc">5. Writing CONF function (in source .c file)</a></li>
<li class="level1"><a href="#page_FunctionParameterStructure_WritingRUNfunc">6. Writing RUN function (in source .c file)</a><ul><li class="level2"><a href="#page_FunctionParameterStructure_WritingRUNfunc_simple">6.1. A simple _RUN example</a></li>
<li class="level2"><a href="#page_FunctionParameterStructure_WritingRUNfunc_processinfo">6.3. RUN function with FPS and processinfo</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>This file: ./src/CommandLineInterface/doc/FunctionParameterStructure.md</dd></dl>
<hr/>
<p><b>The function parameter structure (FPS) exposes a function's internal variables for read and/or write. It is stored in shared memory, in /tmp/&lt;fpsname&gt;.fps.shm.</b></p>
<p>Steps to run FPS-enabled processes: </p><pre class="fragment">$ vim fpslist.txt               # Edit file, listing functions and corresponding FPS names that will be used
$ fpsmkcmd                      # create FPS scripts in `./fpscmd/`
$ ./fpscmd/fpsinitscript        # create FPS shared memory structure(s)
$ ./fpscmd/fpsconfstartscript   # start FPS configuration process(es)
$ fpsCTRL -m _ALL               # FPS control tool, scan ALL FPSs (-m: force match with fpscmd/fpslist.txt)
Type 'P' to im(P)ort configuration
</pre><hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_Overview"></a>
1. Overview and background</h1>
<h2>1.1. Main elements</h2>
<p>FPS-enabled functions have the following elements:</p><ul>
<li>The shared memory FPS: /tmp/&lt;fpsname&gt;.fps.shm</li>
<li>A configuration process that manages the FPS entries</li>
<li>A run process (the function itself)</li>
</ul>
<h2>1.2. FPS name</h2>
<p>&lt;fpsname&gt; consists of a root name (string), and a series of optional integers. Note that the number of digits matters and is part of the name: </p><pre class="fragment">&lt;fpsname&gt; = &lt;fpsnameroot&gt;.&lt;opt0&gt;.&lt;opt1&gt;...
</pre><p>Examples: </p><pre class="fragment">myfps                        # simple name, no optional integers
myfps-000000                 # optional integer 000000
myfps-000043-000020-000002   # 3 optional integers
</pre><dl class="section warning"><dt>Warning</dt><dd>The FPS name does not need to match the process or function name. FPS name is specified in the CLI function as described in <a class="el" href="page_FunctionParameterStructure.html#page_FunctionParameterStructure_WritingCLIfunc"><ol type="1">
<li>Writing the CLI function (in &lt;module&gt;.c file)</li>
</ol>
</a>.</dd></dl>
<h2>1.3. FPS-related entities</h2>
<table class="doxtable">
<tr>
<th>name </th><th>Type </th><th>Description </th><th>Origin  </th></tr>
<tr>
<td>/tmp/&lt;fpsname&gt;.fps.shm </td><td>shared memory </td><td>FP structure </td><td>Created by FPS init function </td></tr>
<tr>
<td>./fpscmd/&lt;fpsnameroot&gt;-confinit </td><td>script </td><td>Initialize FPS </td><td>Built by fpsmkcmd, can be user-edited </td></tr>
<tr>
<td>./fpscmd/&lt;fpsnameroot&gt;-confstart </td><td>script </td><td>Start CONF process </td><td>Built by fpsmkcmd, can be user-edited </td></tr>
<tr>
<td>./fpscmd/&lt;fpsnameroot&gt;-runstart </td><td>script </td><td>Start RUN process </td><td>Built by fpsmkcmd, can be user-edited </td></tr>
<tr>
<td>./fpscmd/&lt;fpsnameroot&gt;-runstop </td><td>script </td><td>Stop RUN process </td><td>Built by fpsmkcmd, can be user-edited </td></tr>
<tr>
<td>&lt;fpsname&gt;-conf </td><td>tmux session </td><td>where CONF runs </td><td>Set up by fpsCTRL </td></tr>
<tr>
<td>&lt;fpsname&gt;-run </td><td>tmux session </td><td>where RUN runs </td><td>Set up by fpsCTRL </td></tr>
<tr>
<td>./fpsconf/&lt;fpsname&gt;/... </td><td>ASCII file </td><td>parameter value </td><td>&lt;TBD&gt; </td></tr>
</table>
<hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_UserInterface"></a>
2. FPS user interface</h1>
<p>Main steps to enable FPS-enabled function for fpsCTRL:</p>
<ul>
<li>Add entry in ./fpslist.txt</li>
<li>Run milk-fpsmkcmd</li>
<li>Run ./fpscmd/&lt;fpsname&gt;-confinit</li>
</ul>
<p>These steps should ideally performed by a setup script.</p>
<h2><a class="anchor" id="page_FunctionParameterStructure_WritingFPSCMDscripts"></a>
2.1. Building command scripts from a `fpslist.txt` file</h2>
<p>The user-provided <code>fpslist.txt</code> file lists the functions and corresponding FPS names that will be in use:</p>
<div class="fragment"><div class="line"># List of FPS-enabled function</div><div class="line"># Column 1: root name used to name FPS</div><div class="line"># Column 2: CLI command</div><div class="line"># Column(s) 3+: optional arguments, integers, 6 digits</div><div class="line"></div><div class="line">fpsrootname0    CLIcommand0</div><div class="line">fpsrootname1    CLIcommand1     optarg00    optarg01</div></div><!-- fragment --><p>FPS command scripts are built by </p><pre class="fragment">$ fpsmkcmd
</pre><p>The command will create the FPS command scripts in directory <code>./fpscmd/</code>, which are then called by the <a class="el" href="page_FunctionParameterStructure.html#page_FunctionParameterStructure_fpsCTRL">2.2. fpsCTRL tool</a> to control the CONF and RUN processes.</p>
<h2><a class="anchor" id="page_FunctionParameterStructure_fpsCTRL"></a>
2.2. fpsCTRL tool</h2>
<p>The FPS control tool is started from the command line : </p><pre class="fragment">$ fpsCTRL
</pre><hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_WritingCLIfunc"></a>
3. Writing the CLI function (in &lt;module&gt;.c file)</h1>
<p>A single CLI function, named &lt;functionname&gt;_cli, will take the following arguments:</p><ul>
<li>arg1: A command code</li>
<li>arg2+: Optional arguments</li>
</ul>
<p>The command code is a string, and will determine the action to be executed:</p><ul>
<li><code>_FPSINIT_</code> : Initialize FPS for the function</li>
<li><code>_CONFSTART_</code> : Start the FPS configuration process</li>
<li><code>_CONFSTOP_</code> : Stop the FPS configuration process</li>
<li><code>_RUNSTART_</code> : Start the run process</li>
<li><code>_RUNSTOP_</code> : Stop the run process</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Why Optional arguments to CLI function ? </dd>
<dd>
Multiple instances of a C function may need to be running, each with its own FPS. Optional arguments provides a mechanism to differentiate the FPSs. They are appended to the FPS name following a dash. Optional arguments can be a number (usually integer) or a string.</dd></dl>
<p>Example source code below.</p>
<div class="fragment"><div class="line">errno_t ExampleFunction_cli()</div><div class="line">{</div><div class="line">    <span class="comment">// try FPS implementation</span></div><div class="line">    <span class="comment">// set data.fpsname, providing default value as first arg, and set data.FPS_CMDCODE value</span></div><div class="line">    <span class="comment">// default FPS name will be used if CLI process has NOT been named</span></div><div class="line">    <span class="comment">// see code in function_parameter.c for detailed rules</span></div><div class="line">    <a class="code" href="function__parameters_8c.html#ae08ea43e607b4b66e8fc21ae4ee5f37a">function_parameter_getFPSname_from_CLIfunc</a>(<span class="stringliteral">&quot;measlinRM&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(data.FPS_CMDCODE != 0) { <span class="comment">// use FPS implementation   </span></div><div class="line">        <span class="comment">// set pointers to CONF and RUN functions</span></div><div class="line">        data.FPS_CONFfunc = ExampleFunction_FPCONF;</div><div class="line">        data.FPS_RUNfunc  = ExampleFunction_RUN;</div><div class="line">        function_parameter_execFPScmd();</div><div class="line">        <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// call non FPS implementation - all parameters specified at function launch</span></div><div class="line">    <span class="keywordflow">if</span>(</div><div class="line">        CLI_checkarg(1, 1) +</div><div class="line">        CLI_checkarg(2, 2) </div><div class="line">        == 0) {</div><div class="line">        ExampleFunction(</div><div class="line">            data.cmdargtoken[1].val.numf,</div><div class="line">            data.cmdargtoken[2].val.numl</div><div class="line">        );</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="keywordflow">return</span> CLICMD_INVALID_ARG;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_WritingPrototypes"></a>
4. Writing function prototypes (in &lt;module&gt;.h)</h1>
<div class="fragment"><div class="line">errno_t ExampleFunction_FPCONF();</div><div class="line">errno_t ExampleFunction_RUN();</div><div class="line">errno_t ExampleFunction(<span class="keywordtype">long</span> arg0num, <span class="keywordtype">long</span> arg1num, <span class="keywordtype">long</span> arg2num, <span class="keywordtype">long</span> arg3num);</div></div><!-- fragment --><hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_WritingCONFfunc"></a>
5. Writing CONF function (in source .c file)</h1>
<p>Check <a class="el" href="function__parameters_8h.html" title="Tools to help expose and control function parameters. ">function_parameters.h</a> for full list of flags.</p>
<div class="fragment"><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// manages configuration parameters</span></div><div class="line"><span class="comment">// initializes configuration parameters structure</span></div><div class="line"><span class="comment">//</span></div><div class="line">errno_t ExampleFunction_FPCONF(</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <span class="comment">// SETUP FPS</span></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <a class="code" href="group__fpsmacro.html#gade74dae399d86f7240287f5255bc13f3">FPS_SETUP_INIT</a>(data.FPS_name, data.FPS_CMDMODE); <span class="comment">// macro in function_parameter.h</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line">    <span class="comment">// ========= ALLOCATE FPS ENTRIES ===============</span></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> *pNull = NULL;</div><div class="line">    uint64_t FPFLAG;</div><div class="line"></div><div class="line">    <span class="comment">// Entries are added one by one with function_parameter_add_entry()</span></div><div class="line">    <span class="comment">// For each entry, we record the function parameter index (fpi_) returned by the function so that parameters can conveniently be accesses in the &quot;LOGIC&quot; section</span></div><div class="line">    <span class="comment">// Arguments:</span></div><div class="line">    <span class="comment">//   - pointer to fps</span></div><div class="line">    <span class="comment">//   - parameter path for GUI</span></div><div class="line">    <span class="comment">//   - description</span></div><div class="line">    <span class="comment">//   - type</span></div><div class="line">    <span class="comment">//   - flags</span></div><div class="line">    <span class="comment">//   - initialization pointer. If pNull, then the variable is not initialized</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// Check CommandLineInterface/function_parameters.h for full list of flags.</span></div><div class="line"></div><div class="line">    <span class="keywordtype">long</span> fpi_param01 = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.param01&quot;</span>, <span class="stringliteral">&quot;First parameter&quot;</span>,</div><div class="line">                       FPTYPE_INT64, FPFLAG_DEFAULT_INPUT, pNull);</div><div class="line"></div><div class="line">    <span class="comment">// This parameter will be intitialized to a value of 5, min-max range from 0 to 10, and current value 5</span></div><div class="line">    int64_t param02default[4] = { 5, 0, 10, 5 };</div><div class="line">    FPFLAG = FPFLAG_DEFAULT_INPUT | FPFLAG_MINLIMIT | FPFLAG_MAXLIMIT;  <span class="comment">// required to enforce the min and max limits</span></div><div class="line">    FPFLAG &amp;= ~FPFLAG_WRITECONF;  <span class="comment">// Don&#39;t allow parameter to be written during configuration</span></div><div class="line">    FPFLAG &amp;= ~FPFLAG_WRITERUN;   <span class="comment">// Don&#39;t allow parameter to be written during run</span></div><div class="line">    <span class="keywordtype">long</span> fpi_param02 = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.param02&quot;</span>, <span class="stringliteral">&quot;Second parameter&quot;</span>,</div><div class="line">                       FPTYPE_INT64, FPFLAG, &amp;param02default);</div><div class="line"></div><div class="line">    <span class="comment">// if parameter type = FPTYPE_FLOAT32, make sure default is declared as float[4]</span></div><div class="line">    <span class="comment">// if parameter type = FPTYPE_FLOAT64, make sure default is declared as double[4]</span></div><div class="line">    <span class="keywordtype">float</span> gaindefault[4] = { 0.01, 0.0, 1.0, 0.01 };</div><div class="line">    FPFLAG = FPFLAG_DEFAULT_INPUT | FPFLAG_MINLIMIT | FPFLAG_MAXLIMIT;  <span class="comment">// required to enforce the min and max limits</span></div><div class="line">    <span class="keywordtype">long</span> fpi_gain = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.gain&quot;</span>, <span class="stringliteral">&quot;gain value&quot;</span>,</div><div class="line">                    FPTYPE_FLOAT32, FPFLAG, &amp;gaindefault);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// This parameter is a ON / OFF toggle</span></div><div class="line">    <span class="keywordtype">long</span> fpi_gainset = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.option.gainwrite&quot;</span>, <span class="stringliteral">&quot;gain can be changed&quot;</span>,</div><div class="line">                       FPTYPE_ONOFF, FPFLAG_DEFAULT_INPUT, pNull);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// stream that needs to be loaded on startup</span></div><div class="line">    FPFLAG = FPFLAG_DEFAULT_INPUT_STREAM;</div><div class="line">    <span class="keywordtype">long</span> fpi_streamname_wfs       = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.sn_wfs&quot;</span>,  <span class="stringliteral">&quot;WFS stream name&quot;</span>,</div><div class="line">                                    FPTYPE_STREAMNAME, FPFLAG, pNull);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Output file name</span></div><div class="line">    <span class="keywordtype">long</span> fpi_filename_out1          = <a class="code" href="function__parameters_8c.html#ab5fd7ed4766f82b5d24504f5e8b8ebb3">function_parameter_add_entry</a>(&amp;fps, <span class="stringliteral">&quot;.out.fname_out1&quot;</span>, <span class="stringliteral">&quot;output file 1&quot;</span>,</div><div class="line">                                      FPTYPE_FILENAME, FPFLAG_DEFAULT_OUTPUT, pNull);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Macros examples</span></div><div class="line">    <span class="comment">// see function_parameters.h</span></div><div class="line"></div><div class="line">    FPS_ADDPARAM_STREAM_IN  (stream_inname,        <span class="stringliteral">&quot;.in_name&quot;</span>,     <span class="stringliteral">&quot;input stream&quot;</span>);</div><div class="line">    FPS_ADDPARAM_STREAM_OUT (stream_outname,       <span class="stringliteral">&quot;.out_name&quot;</span>,    <span class="stringliteral">&quot;output stream&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">long</span> timeavemode_default[4] = { 0, 0, 3, 0 };</div><div class="line">    FPS_ADDPARAM_INT64_IN  (</div><div class="line">        option_timeavemode,</div><div class="line">        <span class="stringliteral">&quot;.option.timeavemode&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Enable time window averaging (&gt;0)&quot;</span>,</div><div class="line">        &amp;timeavemode_default);</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> avedt_default[4] = { 0.001, 0.0001, 1.0, 0.001};</div><div class="line">    FPS_ADDPARAM_FLT64_IN  (</div><div class="line">        option_avedt,</div><div class="line">        <span class="stringliteral">&quot;.option.avedt&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Averaging time window width&quot;</span>,</div><div class="line">        &amp;avedt_default);</div><div class="line"></div><div class="line">    <span class="comment">// status</span></div><div class="line">    FPS_ADDPARAM_INT64_OUT (zsize,        <span class="stringliteral">&quot;.status.zsize&quot;</span>,     <span class="stringliteral">&quot;cube size&quot;</span>);</div><div class="line">    FPS_ADDPARAM_INT64_OUT (framelog,     <span class="stringliteral">&quot;.status.framelag&quot;</span>,  <span class="stringliteral">&quot;lag in frame unit&quot;</span>);</div><div class="line">    FPS_ADDPARAM_INT64_OUT (kkin,         <span class="stringliteral">&quot;.status.kkin&quot;</span>,      <span class="stringliteral">&quot;input cube slice index&quot;</span>);</div><div class="line">    FPS_ADDPARAM_INT64_OUT (kkout,        <span class="stringliteral">&quot;.status.kkout&quot;</span>,     <span class="stringliteral">&quot;output cube slice index&quot;</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line">    <span class="comment">// ======== START FPS CONF LOOP =================</span></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line">    FPS_CONFLOOP_START  <span class="comment">// macro in function_parameter.h</span></div><div class="line"></div><div class="line">    <span class="comment">// here goes the logic</span></div><div class="line">    <span class="keywordflow">if</span> ( fps.parray[fpi_gainset].fpflag &amp; FPFLAG_ONOFF )  <span class="comment">// ON state</span></div><div class="line">    {</div><div class="line">        fps.parray[fpi_gain].fpflag |= FPFLAG_WRITERUN;</div><div class="line">        fps.parray[fpi_gain].fpflag |= FPFLAG_USED;</div><div class="line">        fps.parray[fpi_gain].fpflag |= FPFLAG_VISIBLE;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="comment">// OFF state</span></div><div class="line">    {</div><div class="line"></div><div class="line">        fps.parray[fpi_gain].fpflag &amp;= ~FPFLAG_WRITERUN;</div><div class="line">        fps.parray[fpi_gain].fpflag &amp;= ~FPFLAG_USED;</div><div class="line">        fps.parray[fpi_gain].fpflag &amp;= ~FPFLAG_VISIBLE;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line">    <span class="comment">// ======== STOP FPS CONF LOOP ==================</span></div><div class="line">    <span class="comment">// ==============================================</span></div><div class="line">    FPS_CONFLOOP_END  <span class="comment">// macro in function_parameter.h</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><hr/>
<h1><a class="anchor" id="page_FunctionParameterStructure_WritingRUNfunc"></a>
6. Writing RUN function (in source .c file)</h1>
<p>The RUN function will connect to the FPS and execute the run loop.</p>
<h2><a class="anchor" id="page_FunctionParameterStructure_WritingRUNfunc_simple"></a>
6.1. A simple _RUN example</h2>
<div class="fragment"><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// run loop process</span></div><div class="line"><span class="comment">//</span></div><div class="line">errno_t ExampleFunction_RUN(</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <span class="comment">// CONNECT TO FPS</span></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    FPS_CONNECT(data.FPS_name, FPSCONNECT_RUN );</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ===============================</span></div><div class="line">    <span class="comment">// GET FUNCTION PARAMETER VALUES</span></div><div class="line">    <span class="comment">// ===============================</span></div><div class="line"></div><div class="line">    <span class="comment">// parameters are addressed by their tag name</span></div><div class="line"></div><div class="line">    <span class="comment">// These parameters are read once, before running the loop</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keywordtype">int</span> param01 = functionparameter_GetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.param01&quot;</span>);</div><div class="line">    <span class="keywordtype">int</span> param02 = functionparameter_GetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.param02&quot;</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// This parameter is a ON / OFF toggle</span></div><div class="line">    <span class="keywordtype">int</span> gainwrite = functionparameter_GetParamValue_ONOFF(&amp;fps, <span class="stringliteral">&quot;.option.gainwrite&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// This parameter value will be tracked during loop run, so we create a pointer for it</span></div><div class="line">    <span class="comment">// The corresponding function is functionparameter_GetParamPtr_&lt;TYPE&gt;</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keywordtype">float</span> *gain = functionparameter_GetParamPtr_FLOAT32(&amp;fps, <span class="stringliteral">&quot;.status.loopcnt&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> imsname[FUNCTION_PARAMETER_STRMAXLEN];</div><div class="line">    strncpy(imsname, functionparameter_GetParamPtr_STRING(&amp;fps, <span class="stringliteral">&quot;.option.imname&quot;</span>), FUNCTION_PARAMETER_STRMAXLEN);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// connect to WFS image</span></div><div class="line">        <span class="keywordtype">long</span> IDim = read_sharedmem_image(imsname);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ===============================</span></div><div class="line">    <span class="comment">// RUN LOOP</span></div><div class="line">    <span class="comment">// ===============================</span></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> loopOK = 1;</div><div class="line">    <span class="keywordflow">while</span>( loopOK == 1 )</div><div class="line">    {</div><div class="line">        <span class="comment">// here we compute what we need...</span></div><div class="line">        <span class="comment">//</span></div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// Note that some mechanism is required to set loopOK to 0 when MyFunction_Stop() is called</span></div><div class="line">        <span class="comment">// This can use a separate shared memory path</span></div><div class="line">    }</div><div class="line"></div><div class="line">    function_parameter_RUNexit( &amp;fps );</div><div class="line">    <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h2>6.2. Non-FPS fallback function</h2>
<div class="fragment"><div class="line">errno_t ExampleFunction(</div><div class="line">    <span class="keywordtype">long</span> arg0num, </div><div class="line">    <span class="keywordtype">long</span> arg1num, </div><div class="line">    <span class="keywordtype">long</span> arg2num, </div><div class="line">    <span class="keywordtype">long</span> arg3num</div><div class="line">) {</div><div class="line">    <span class="keywordtype">char</span> fpsname[200];</div><div class="line"></div><div class="line">    <span class="keywordtype">long</span> pindex = (long) getpid();  <span class="comment">// index used to differentiate multiple calls to function</span></div><div class="line">    <span class="comment">// if we don&#39;t have anything more informative, we use PID</span></div><div class="line"></div><div class="line">    <a class="code" href="structFUNCTION__PARAMETER__STRUCT.html">FUNCTION_PARAMETER_STRUCT</a> fps;</div><div class="line"></div><div class="line">    <span class="comment">// create FPS</span></div><div class="line">    sprintf(data.FPS_name, <span class="stringliteral">&quot;exfunc-%06ld&quot;</span>, pindex);</div><div class="line">    data.FPS_CMDMODE = FPSCMDCODE_FPSINIT;</div><div class="line">    ExampleFunction_FPCONF();</div><div class="line"></div><div class="line">    <a class="code" href="function__parameters_8c.html#a4eb2b4db6e7d81a93556e26a0a1df6cc">function_parameter_struct_connect</a>(data.FPS_name, &amp;fps, FPSCONNECT_SIMPLE);</div><div class="line"></div><div class="line">    functionparameter_SetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.arg0&quot;</span>, arg0);</div><div class="line">    functionparameter_SetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.arg1&quot;</span>, arg1);</div><div class="line">    functionparameter_SetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.arg2&quot;</span>, arg2);</div><div class="line">    functionparameter_SetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.arg3&quot;</span>, arg3);</div><div class="line"></div><div class="line">    function_parameter_struct_disconnect(&amp;fps);</div><div class="line"></div><div class="line">    ExampleFunction_RUN();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="page_FunctionParameterStructure_WritingRUNfunc_processinfo"></a>
6.3. RUN function with FPS and processinfo</h2>
<p>In this example, the loop process supports both FPS and processinfo. This is the preferred way to code a loop process.</p>
<p>The example also shows using FPS to set the process realtime priority.</p>
<div class="fragment"><div class="line"><span class="comment">/* \@brief Loop process code example</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ## Purpose</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This example demonstrates use of processinfo and fps structures.\n</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * All function parameters are held inside the function parameter structure (FPS).\n</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ## Details</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">errno_t MyFunction_RUN(</div><div class="line">)</div><div class="line">{</div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <span class="comment">// ### Connect to FPS </span></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    FPS_CONNECT( data.FPS_name, FPSCONNECT_RUN );</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ===================================  </span></div><div class="line">    <span class="comment">// ### GET FUNCTION PARAMETER VALUES</span></div><div class="line">    <span class="comment">// ===================================</span></div><div class="line">    <span class="comment">// parameters are addressed by their tag name</span></div><div class="line"></div><div class="line">    <span class="comment">// These parameters are read once, before running the loop</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keywordtype">int</span> param01 = functionparameter_GetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.param01&quot;</span>);</div><div class="line">    <span class="keywordtype">int</span> param02 = functionparameter_GetParamValue_INT64(&amp;fps, <span class="stringliteral">&quot;.param02&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> nameim[FUNCTION_PARAMETER_STRMAXLEN+1];</div><div class="line">    strncpy(nameim, functionparameter_GetParamPtr_STRING(&amp;fps, <span class="stringliteral">&quot;.option.nameim&quot;</span>), FUNCTION_PARAMETER_STRMAXLEN);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// This parameter value will be tracked during loop run, so we create a pointer for it</span></div><div class="line">    <span class="comment">// The corresponding function is functionparameter_GetParamPtr_&lt;TYPE&gt;</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keywordtype">float</span> *gain = functionparameter_GetParamPtr_FLOAT32(&amp;fps, <span class="stringliteral">&quot;.ctrl.gain&quot;</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <span class="comment">// ### processinfo support </span></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line"></div><div class="line">    <a class="code" href="structPROCESSINFO.html">PROCESSINFO</a> *processinfo;</div><div class="line"></div><div class="line">    processinfo = processinfo_setup(</div><div class="line">        data.FPS_name,               <span class="comment">// re-use fpsname as processinfo name</span></div><div class="line">        <span class="stringliteral">&quot;computes something&quot;</span>,    <span class="comment">// description</span></div><div class="line">        <span class="stringliteral">&quot;add image1 to image2&quot;</span>,  <span class="comment">// message on startup</span></div><div class="line">        __FUNCTION__, __FILE__, __LINE__</div><div class="line">        );</div><div class="line"></div><div class="line">    <span class="comment">// OPTIONAL SETTINGS</span></div><div class="line">    processinfo-&gt;MeasureTiming = 1; <span class="comment">// Measure timing </span></div><div class="line">    processinfo-&gt;RT_priority = 20;  <span class="comment">// RT_priority, 0-99. Larger number = higher priority. If &lt;0, ignore</span></div><div class="line">    processinfo-&gt;loopcntMax = 1000; <span class="comment">// max number of iterations. -1 if infinite</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> loopOK = 1;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// =============================================</span></div><div class="line">    <span class="comment">// OPTIONAL: TESTING CONDITION FOR LOOP ENTRY</span></div><div class="line">    <span class="comment">// =============================================</span></div><div class="line">    <span class="comment">// Pre-loop testing, anything that would prevent loop from starting should issue message</span></div><div class="line">    <span class="keywordtype">int</span> loopOK = 1;</div><div class="line">    <span class="keywordflow">if</span>(.... error condition ....)</div><div class="line">    {</div><div class="line">        <span class="comment">// exit function with ERROR status</span></div><div class="line">        processinfo_error(processinfo, <span class="stringliteral">&quot;ERROR: no WFS reference&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> RETURN_FAILURE;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line">    <span class="comment">// ### Start loop</span></div><div class="line">    <span class="comment">// ===========================</span></div><div class="line"></div><div class="line"></div><div class="line">    processinfo_loopstart(processinfo); <span class="comment">// Notify processinfo that we are entering loop</span></div><div class="line"></div><div class="line">    <span class="keywordflow">while</span>(loopOK==1)</div><div class="line">    {</div><div class="line">        loopOK = processinfo_loopstep(processinfo);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">// Semaphore wait goes here  </span></div><div class="line">        <span class="comment">// computation starts here</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        processinfo_exec_start(processinfo);    </div><div class="line">        <span class="keywordflow">if</span>(processinfo_compute_status(processinfo)==1)</div><div class="line">        {</div><div class="line">            <span class="comment">//</span></div><div class="line">            <span class="comment">// computation ....</span></div><div class="line">            <span class="comment">//</span></div><div class="line">        }</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// Post semaphore(s) and counter(s) </span></div><div class="line">        <span class="comment">// computation done</span></div><div class="line"></div><div class="line">        <span class="comment">// process signals, increment loop counter</span></div><div class="line">        processinfo_exec_end(processinfo);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// OPTIONAL: MESSAGE WHILE LOOP RUNNING</span></div><div class="line">        processinfo_WriteMessage(processinfo, <span class="stringliteral">&quot;loop running fine&quot;</span>);     </div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ==================================</span></div><div class="line">    <span class="comment">// ### ENDING LOOP</span></div><div class="line">    <span class="comment">// ==================================</span></div><div class="line"></div><div class="line">     processinfo_cleanExit(processinfo);</div><div class="line">    function_parameter_RUNexit( &amp;fps  );</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> RETURN_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><hr/>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="page_coding_standards.html">Coding Standards</a></li>
    <li class="footer">Generated on Mon Apr 20 2020 22:37:12 for milk by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
