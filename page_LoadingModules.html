<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>milk: Loading, Creating Additional Modules</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">milk
   &#160;<span id="projectnumber">1.01</span>
   </div>
   <div id="projectbrief">Modular Image processing Library toolKit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_LoadingModules.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Loading, Creating Additional Modules </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>This file: ./src/CommandLineInterface/doc/LoadingModules.md</dd></dl>
<hr  />
<p>Users can create additional modules, and following a few milk-specific conventions, link their functions to the milk CLI. Additional modules can be added to the existing build process or compiled separately and then loaded at runtime.</p>
<hr  />
<h1><a class="anchor" id="page_LoadingModules_overview"></a>
1. Overview</h1>
<p>milk is oganized in modules, each compiled as a shared object and loaded at runtime.</p>
<h2><a class="anchor" id="page_LoadingModules_overview_compiling"></a>
1.1. Compiling</h2>
<p>While milk comes with its own set of modules, others can be added at runtime. Modules that conform to milk specifications can be downloaded and added by following these steps: </p><pre class="fragment"># execute these commands from the source root directory (for example ~./milk/)
# move to source subdir, where module directories are located
$ cd ./src

# Download a new module
$ git clone https://github.com/milk-org/NewModuleName

# move to build directory
$ cd ../_build

# Add new module to compile script
$ cmake .. -DEXTRAMODULES="NewModuleName"

# compile and install
$ sudo make install
</pre><h2><a class="anchor" id="page_LoadingModules_overview_linking"></a>
1.2. Runtime linking</h2>
<p>Note that the commands above will compile the module into a shared object, but it will not be loaded by default at runtime. There are 4 options to load the module into the milk executable, detailed in the following section. For example, the new module may be loaded within the milk command line interface as follows: </p><pre class="fragment"># start milk
$ milk

# load module from command line interface
milk&gt; mload NewModuleName 

# check list of modules. NewModuleName should appear
milk&gt; m?
</pre><h2><a class="anchor" id="page_LoadingModules_overview_example"></a>
1.3. A simple example</h2>
<p>milk includes an example module, which is not compiled or linked by default, to demonstrate how to write and add modules.</p>
<p>The example module is in directory 'src/milk_module_example' : </p><pre class="fragment">$ cd src/milk_module_example
$ ls
CMakeLists.txt
create_example_image.c
create_example_image.h
milk_module_example.c
milk_module_example.h
... additional .c and .h files
</pre><p>Check the source code (well documented) to see how modules are written. To compile : </p><pre class="fragment">$ cd _build
$ cmake .. -DEXTRAMODULES="milk_module_example"
$ sudo make install
</pre><p>Lets run it : </p><pre class="fragment"># start milk
$ milk

# load module as "mex" (short for module example)
milk&gt; mloadas milk_module_example mex

# check we have it
milk&gt; m?

# run the test function, which creates an image
# note you can tab complete after typying "mex." to list functions
milk&gt; mex.func1 im1 1.2

# check the image is in memory
milk&gt; listim
</pre><hr  />
<h1><a class="anchor" id="page_LoadingModules_linking"></a>
2. Linking Modules to CLI</h1>
<h2><a class="anchor" id="page_LoadingModules_linking_libdir"></a>
2.1. Automatic linking from &lt;tt&gt;./lib/&lt;/tt&gt; directory</h2>
<p>Any shared object in the <code>./lib/</code> subdirectory of source code will be loaded upon startup.</p>
<h2><a class="anchor" id="page_LoadingModules_linking_soload"></a>
2.2. Linking module from within CLI with soload</h2>
<p>Pre-compiled modules can be linked with the <code>soload</code> command within the CLI: </p><pre class="fragment">milk&gt; soload &lt;fullsoname&gt;
</pre><p>The <code>fullsoname</code> is the shared object file name, path relative to current directory. For example "../mylib/myodule.so".</p>
<p>Provided that the module follows milk conventions, linking the module will add the corresponding functions to the CLI. This can be checked by probing the module functions: </p><pre class="fragment">milk&gt; m?                # lists linked modules
milk&gt; m? &lt;modulename&gt;   # lists CLI commands in the module
</pre><h2><a class="anchor" id="page_LoadingModules_linking_mload"></a>
2.3. Linking module from within CLI with mload</h2>
<p>By default, modules shared objects are installed in <code>/usr/local/milk/lib</code>, and are named <code>lib&lt;ModuleName&gt;.so</code>. With these assumptions satisfied, modules can be linked from within the CLI with the <code>mload</code> command: </p><pre class="fragment">milk&gt; mload &lt;modulename&gt;
</pre><p>Alternatively, a short name can be specified </p><pre class="fragment">milk&gt; mloadas &lt;modulename&gt; &lt;shortname&gt;
</pre><p>Module functions are called from the command line interface prompt: </p><pre class="fragment">milk&gt; &lt;shortname&gt;.&lt;functionname&gt; &lt;arguments...&gt;
</pre><h2><a class="anchor" id="page_LoadingModules_linking_envvar"></a>
2.4. Using environment variable &lt;tt&gt;CLI_ADD_LIBS&lt;/tt&gt; to link shared objects</h2>
<p>Upon startup, milk will read the CLI_ADD_LIBS environment variable to link shared objects. For example: </p><pre class="fragment">CLI_ADD_LIBS="/usr/local/milk/lib/libMyFirstModule.so /usr/local/milk/lib/libMySecondModule.so" milk
</pre><p>will link modules <code>MyFirstModule</code> and <code>MySecondModule</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Shared object names can be separated by space, semicolumn, or comma.</dd></dl>
<hr  />
<h1><a class="anchor" id="page_LoadingModules_compiling"></a>
3. Writing and Compiling Modules</h1>
<h2><a class="anchor" id="page_LoadingModules_compiling_principles"></a>
3.1. Principles</h2>
<p>Modules that are always loaded upon startup are explicitely listed in CLImain.c. Additional modules may be loaded using the C dlopen() command. The library should include a function <code>initlib_&lt;modulename&gt;</code> to be executed when the module is loaded. This function should register functions to the command line interface, as done for all other modules that are part of the distribution.</p>
<dl class="section see"><dt>See also</dt><dd><a href="http://www.linux-mag.com/id/1028/">http://www.linux-mag.com/id/1028/</a> for instructions to create shared libraries that can be loaded as modules. </dd>
<dd>
<a href="https://www.gnu.org/software/automake/manual/html_node/Libtool-Convenience-Libraries.html">https://www.gnu.org/software/automake/manual/html_node/Libtool-Convenience-Libraries.html</a></dd></dl>
<h2><a class="anchor" id="page_LoadingModules_compiling_compiling_cmake"></a>
3.2. Adding modules to the main package compilation</h2>
<p>The preferred way to add modules is to have them within the main source code directory alongside default modules, following the same conventions and locations as the default modules. A new module should then have the following files in the <code>./src/&lt;ModuleName&gt;/</code> directory:</p>
<ul>
<li><code>CMakeLists.txt</code> file</li>
<li>source code files (.c and .h files)</li>
</ul>
<p>The <code>EXTRAMODULES</code> option is then used to add entry(ies) to the list of compiled modules. For example: </p><pre class="fragment">cmake .. -DEXTRAMODULES="WFpropagate;OpticsMaterials"
</pre><p>will compile modules <code>WFpropagate</code> and <code>OpticsMaterials</code> in addition to default modules. The extra modules shared objects will be <code>/usr/local/lib/libWFpropagate.so</code> and <code>/usr/local/lib/libOpticsMaterials.so</code>, and can be loaded with any of the methods described in the linking section.</p>
<dl class="section attention"><dt>Attention</dt><dd>Adding entries with the EXTRAMODULES option will compile the corresponding shared objects, but will not have them loaded upon execution of the main executable. See section <a class="el" href="page_LoadingModules.html#page_LoadingModules_compiling_autoloading">3.3. Automatic loading</a>.</dd></dl>
<h2><a class="anchor" id="page_LoadingModules_compiling_autoloading"></a>
3.3. Automatic loading</h2>
<p>Several options are available to have the additional module(s) automatically loaded every time:</p>
<ul>
<li>Copy or link the shared object to the <code>./lib/</code> directory (see <a class="el" href="page_LoadingModules.html#page_LoadingModules_linking_libdir">2.1. Automatic linking from <code>./lib/</code> directory</a>).</li>
</ul>
<p>For example: </p><pre class="fragment">ln -s /usr/local/lib/libWFpropagate.so ~./lib/libWFpropagate.so
</pre><ul>
<li>Create a system-wide environment variable CLI_ADD_LIBS in <code>~/.bashrc</code> (see <a class="el" href="page_LoadingModules.html#page_LoadingModules_linking_envvar">2.4. Using environment variable <code>CLI_ADD_LIBS</code> to link shared objects</a>)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Several versions of the executable can also be defined, each with its own set of automatically loaded modules. For example, the following line can be saved as an executable script: <pre class="fragment">CLI_ADD_LIBS="/usr/local/libs/libWFpropagate.so" milk
</pre></dd></dl>
<h2><a class="anchor" id="page_LoadingModules_compiling_addingmodulegithub"></a>
3.4. Adding new module to github</h2>
<p>We assume here that you have created a module and you would like to push it to the main github package org (we assume here milk-org). </p><pre class="fragment"># First, create the repo in github, then run the following commands:
cd ./MyModuleName/
git init
git add .
git commit -m "First commit"
git remote add origin https://github.com/milk-org/MyModuleName
git config credential.helper store       # For convenience
git push --set-upstream origin master
# Now we create dev branch
git checkout -b dev
git push --set-upstream origin dev
</pre><h1><a class="anchor" id="page_LoadingModules_custom"></a>
4. Custom modules</h1>
<p>Additional custom modules may also be compiled independently from the main compile process. This is not the preferred option, and there is a performance hit, as the benefits of link-time optimization will be lost.</p>
<p>To compile a custom module : </p><pre class="fragment">cd exampleModule
gcc -c -I.. -fPIC exampleModule.c
gcc -c -fPIC compute_pi.c -Ofast
gcc -shared -I.. -fPIC exampleModule.o compute_pi.o -o libexamplemodule.so -lc
</pre><p>To load the new modules automatically on milk startup, create a sym link in the milk's lib directory: </p><pre class="fragment">cd ~/src/milk/lib
ln -s ../src/exampleModule/libexamplemodule.so libexamplemodule.so
</pre><p>Alternatively, you can load it from the CLI at anytime: </p><pre class="fragment">milk &gt; soload "&lt;pathtomilk&gt;/src/exampleModule/libexamplemodule.so"
</pre><hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Sep 11 2020 22:34:29 for milk by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
